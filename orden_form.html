<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Formulario Orden</title>
</head>
<body>
  <h1 id="title">Nueva Orden</h1>
  <p><a id="lnkVolver" href="ordenes.html">Volver</a></p>

  <form id="form" style="max-width:780px;">
    <div style="margin:10px 0;">
      <label><b>Paciente</b></label><br />
      <select id="paciente" required style="width:100%; padding:8px;"></select>
    </div>

    <div style="margin:10px 0;">
      <label><b>Médico solicitante</b></label><br />
      <select id="medico" required style="width:100%; padding:8px;"></select>
      <small id="medicoHint" style="display:block; margin-top:6px; color:#555;"></small>
    </div>

    <div style="margin:10px 0;">
      <label><b>Tipo de examen (FONASA)</b></label><br />
      <select id="examen" required style="width:100%; padding:8px;"></select>
    </div>

    <div style="margin:10px 0;">
      <label><b>Estado</b></label><br />
      <select id="estado" required style="width:100%; padding:8px;"></select>
    </div>

    <div style="margin:10px 0;">
      <label><b>Prioridad</b></label><br />
      <select id="prioridad" required style="width:100%; padding:8px;">
        <option value="Normal">Normal</option>
        <option value="Urgente">Urgente</option>
      </select>
    </div>

    <div style="margin:10px 0;">
      <label><b>Observaciones clínicas (opcional)</b></label><br />
      <!-- ✅ ID correcto -->
      <textarea id="observaciones" rows="5" style="width:100%; padding:8px;"
        placeholder="Ej: sospecha clínica, indicación, antecedentes relevantes..."></textarea>
    </div>

    <button type="submit">Guardar</button>
    <button type="button" id="btnCancelar">Cancelar</button>
  </form>

  <script type="module">
    import { supabase } from "./assets/supabaseClient.js";
    import { requireAuthOrRedirect, getLocalSession } from "./assets/auth.js";
    import { logEvent } from "./assets/logger.js";

    const params = new URLSearchParams(location.search);
    const id = params.get("id"); // si querés editar después
    const from = (params.get("from") || "").toLowerCase(); // "medico" opcional

    const title = document.getElementById("title");
    const form = document.getElementById("form");

    const paciente = document.getElementById("paciente");
    const medico = document.getElementById("medico");
    const medicoHint = document.getElementById("medicoHint");
    const examen = document.getElementById("examen");
    const estado = document.getElementById("estado");
    const prioridad = document.getElementById("prioridad");
    const observacionesEl = document.getElementById("observaciones");

    const lnkVolver = document.getElementById("lnkVolver");
    const btnCancelar = document.getElementById("btnCancelar");

    function esc(str) {
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    function volverSegunRol() {
      const rol = String(getLocalSession()?.rol || "").toUpperCase();
      if (rol === "MEDICO" || from === "medico") return "mis_ordenes.html";
      return "ordenes.html";
    }

    btnCancelar.addEventListener("click", () => {
      window.location.href = volverSegunRol();
    });

    lnkVolver.href = volverSegunRol();

    async function cargarCombos() {
      const [pRes, mRes, eRes, stRes] = await Promise.all([
        supabase.from("pacientes")
          .select("id,rut,nombre")
          .eq("activo", true)
          .order("nombre"),

        supabase.from("medico_solicitante")
          .select("id,rut,nombre,especialidad")
          .eq("activo", true)
          .order("nombre"),

        supabase.from("tipo_examen")
          .select("id,nombre,codigo")
          .eq("activo", true)
          .order("nombre"),

        supabase.from("estado_orden")
          .select("id,nombre,orden")
          .eq("activo", true)
          .order("orden")
      ]);

      if (pRes.error) alert("Error pacientes: " + pRes.error.message);
      if (mRes.error) alert("Error médicos: " + mRes.error.message);
      if (eRes.error) alert("Error exámenes: " + eRes.error.message);
      if (stRes.error) alert("Error estados: " + stRes.error.message);

      paciente.innerHTML = (pRes.data || [])
        .map(p => `<option value="${p.id}">${esc(p.nombre)} (${esc(p.rut)})</option>`)
        .join("") || `<option value="">(Sin pacientes activos)</option>`;

      medico.innerHTML = (mRes.data || [])
        .map(m => `<option value="${m.id}">${esc(m.nombre)} — ${esc(m.especialidad ?? "")}</option>`)
        .join("") || `<option value="">(Sin médicos activos)</option>`;

      examen.innerHTML = (eRes.data || [])
        .map(x => `<option value="${x.id}">${esc(x.nombre)} — ${esc(x.codigo ?? "")}</option>`)
        .join("") || `<option value="">(Sin exámenes activos)</option>`;

      estado.innerHTML = (stRes.data || [])
        .map(s => `<option value="${s.id}">${esc(s.nombre)}</option>`)
        .join("") || `<option value="">(Sin estados)</option>`;
    }

    // (opcional) si querés que el médico NO cambie estado, lo bloqueamos
    function bloquearEstadoSiMedico(rol) {
      if (String(rol).toUpperCase() === "MEDICO") {
        estado.disabled = true;
        medicoHint.textContent = "Modo médico: podrás crear órdenes, y el estado se mantiene controlado por el flujo.";
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // ✅ Sesión real: de acá sale el created_by
      const { data: sData, error: sErr } = await supabase.auth.getSession();
      const userId = sData?.session?.user?.id;

      if (sErr || !userId) {
        alert("Sesión inválida o expirada. Volvé a iniciar sesión.");
        return;
      }

      // ✅ Payload final (con created_by SIEMPRE seteado)
      const payload = {
        paciente_id: Number(paciente.value),
        medico_id: Number(medico.value),
        tipo_examen_id: Number(examen.value),
        estado_id: Number(estado.value),
        prioridad: prioridad.value,
        observaciones: (observacionesEl.value || "").trim() || null,
        created_by: userId
      };

      if (!payload.paciente_id || !payload.medico_id || !payload.tipo_examen_id || !payload.estado_id) {
        alert("Faltan datos obligatorios.");
        return;
      }

      const resp = await supabase
        .from("orden_radiologica")
        .insert(payload)
        .select("id")
        .single();

      if (resp.error) {
        alert("Error al guardar: " + resp.error.message);
        return;
      }

      // Log (si lo usás)
      await logEvent({
        accion: "CREATE",
        entidad: "orden_radiologica",
        entidad_id: resp.data?.id ?? null,
        detalle: `Orden creada (prioridad: ${payload.prioridad})`
      });

      alert("Orden creada.");
      window.location.href = volverSegunRol();
    });

    // INIT
    const session = await requireAuthOrRedirect(); // guarda localSession (email/rol)
    await cargarCombos();
    bloquearEstadoSiMedico(session?.rol);
  </script>
</body>
</html>
