<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>√ìrdenes radiol√≥gicas</title>
</head>
<body>
  <h1>√ìrdenes radiol√≥gicas</h1>

  <div style="display:flex; gap:8px; align-items:center; margin:12px 0; flex-wrap:wrap;">
    <input id="q" placeholder="Buscar por paciente, m√©dico o c√≥digo examen..." style="width:360px;" />
    <select id="fEstado"></select>
    <select id="fPrioridad">
      <option value="">Prioridad (todas)</option>
      <option value="Normal">Normal</option>
      <option value="Urgente">Urgente</option>
    </select>

    <button id="btnBuscar">Buscar</button>
    <button id="btnLimpiar">Limpiar</button>

    <div style="flex:1"></div>

    <button id="btnNueva">+ Nueva orden</button>
    <button id="btnVolver">Volver</button>
  </div>

  <table border="1" cellpadding="8" cellspacing="0" style="width:100%; max-width:1200px;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Paciente</th>
        <th>M√©dico</th>
        <th>Examen</th>
        <th>C√≥digo</th>
        <th>Estado</th>
        <th>Prioridad</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="8">Cargando...</td></tr>
    </tbody>
  </table>

  <script type="module">
    import { supabase } from "./assets/supabaseClient.js";
    import { logEvent } from "./assets/logger.js";
    import { requireAuthOrRedirect } from "./assets/auth.js";

    // ‚úÖ protege pantalla
    await requireAuthOrRedirect();

    const tbody = document.getElementById("tbody");
    const q = document.getElementById("q");
    const fEstado = document.getElementById("fEstado");
    const fPrioridad = document.getElementById("fPrioridad");

    document.getElementById("btnNueva").addEventListener("click", () => {
      window.location.href = "orden_form.html";
    });
    document.getElementById("btnVolver").addEventListener("click", () => {
      window.location.href = "index.html";
    });
    document.getElementById("btnBuscar").addEventListener("click", () => load());
    document.getElementById("btnLimpiar").addEventListener("click", () => {
      q.value = "";
      fEstado.value = "";
      fPrioridad.value = "";
      load();
    });

    function esc(str) {
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    // Cache de estados para:
    // - poblar filtro
    // - calcular siguiente por "orden"
    let ESTADOS = [];

    async function cargarEstadosEnFiltro() {
      const { data, error } = await supabase
        .from("estado_orden")
        .select("id,nombre,orden,activo")
        .eq("activo", true)
        .order("orden", { ascending: true });

      if (error) {
        fEstado.innerHTML = `<option value="">Estado (error)</option>`;
        ESTADOS = [];
        return;
      }

      ESTADOS = data || [];

      const options = [`<option value="">Estado (todos)</option>`]
        .concat(ESTADOS.map(e => `<option value="${e.id}">${esc(e.nombre)}</option>`));

      fEstado.innerHTML = options.join("");
    }

    function getEstadoById(id) {
      return ESTADOS.find(e => Number(e.id) === Number(id)) || null;
    }

    // ‚úÖ CORREGIDO: si no hay siguiente, devuelve null (no vuelve al primero)
    function getSiguienteEstadoId(estadoActualId) {
  const idx = ESTADOS.findIndex(e => Number(e.id) === Number(estadoActualId));
  if (idx === -1) return null;

  const siguiente = ESTADOS[idx + 1];
  if (!siguiente) return null; // ya est√° en el √∫ltimo estado

  return Number(siguiente.id);
}


    async function load() {
      tbody.innerHTML = `<tr><td colspan="8">Cargando...</td></tr>`;

      let query = supabase
        .from("orden_radiologica")
        .select(`
          id,
          prioridad,
          estado_id,
          paciente:paciente_id ( id, rut, nombre ),
          medico:medico_id ( id, rut, nombre, especialidad ),
          examen:tipo_examen_id ( id, nombre, codigo ),
          estado:estado_id ( id, nombre, orden )
        `)
        .order("id", { ascending: false });

      if (fEstado.value) query = query.eq("estado_id", Number(fEstado.value));
      if (fPrioridad.value) query = query.eq("prioridad", fPrioridad.value);

      const { data, error } = await query;

      if (error) {
        tbody.innerHTML = `<tr><td colspan="8">ERROR: ${esc(error.message)}</td></tr>`;
        return;
      }

      let rows = data || [];

      const term = (q.value || "").trim().toLowerCase();
      if (term) {
        rows = rows.filter(r => {
          const p = (r.paciente?.nombre || "") + " " + (r.paciente?.rut || "");
          const m = (r.medico?.nombre || "") + " " + (r.medico?.rut || "");
          const e = (r.examen?.nombre || "") + " " + (r.examen?.codigo || "");
          return (p + " " + m + " " + e).toLowerCase().includes(term);
        });
      }

      if (rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8">Sin registros</td></tr>`;
        return;
      }

      // ‚úÖ CORREGIDO: el bot√≥n ya no depende de data-estado viejo.
      // Se calcula el texto del bot√≥n desde r.estado_id (que viene del SELECT),
      // y si no hay siguiente, queda "Finalizado".
     tbody.innerHTML = rows.map(r => {
  const estadoActualId = Number(r.estado_id);
  const siguienteId = getSiguienteEstadoId(estadoActualId);

  const estActual = getEstadoById(estadoActualId);
  const estNuevo = siguienteId ? getEstadoById(siguienteId) : null;

  const btnNextHtml = estNuevo
    ? `<button data-next="${r.id}" data-estado="${estadoActualId}" data-next-id="${siguienteId}">
         Siguiente estado (${esc(estNuevo.nombre)})
       </button>`
    : `<button disabled title="Ya est√° en el √∫ltimo estado">Finalizado</button>`;

  return `
    <tr>
      <td>${r.id}</td>
      <td>${esc(r.paciente?.nombre)} <small>(${esc(r.paciente?.rut)})</small></td>
      <td>${esc(r.medico?.nombre)} <small>(${esc(r.medico?.especialidad ?? "")})</small></td>
      <td>${esc(r.examen?.nombre)}</td>
      <td>${esc(r.examen?.codigo)}</td>
      <td>${esc(r.estado?.nombre)}</td>
      <td>${esc(r.prioridad)}</td>
      <td>
        <button data-edit="${r.id}">Editar</button>
        ${btnNextHtml}
      </td>
    </tr>
  `;
}).join("");


      // ‚úÖ (no tocamos tu comportamiento) editar
      tbody.querySelectorAll("[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-edit");
          window.location.href = `orden_form.html?id=${id}`;
        });
      });
      

      // ‚úÖ REEMPLAZO √öNICO: dejamos UN SOLO listener para data-next (el tuyo estaba duplicado)
     tbody.querySelectorAll("[data-next]").forEach(btn => {
  btn.addEventListener("click", async () => {
    const idOrden = Number(btn.getAttribute("data-next"));
    const estadoAnteriorId = Number(btn.getAttribute("data-estado"));
    const siguienteId = Number(btn.getAttribute("data-next-id"));

    if (!siguienteId) {
      alert("La orden ya est√° en el √∫ltimo estado.");
      return;
    }

    const estAnt = getEstadoById(estadoAnteriorId);
    const estNuevo = getEstadoById(siguienteId);

    const { error: e2 } = await supabase
      .from("orden_radiologica")
      .update({ estado_id: siguienteId })
      .eq("id", idOrden);

    if (e2) {
      // üî• ac√° vas a ver si es RLS
      alert("No se pudo cambiar estado: " + e2.message);
      return;
    }

    await logEvent({
      accion: "STATUS",
      entidad: "orden_radiologica",
      entidad_id: idOrden,
      detalle: `Cambio estado: ${estAnt?.nombre ?? estadoAnteriorId} -> ${estNuevo?.nombre ?? siguienteId}`
    });

    load();
  });
});

      
    }

    await cargarEstadosEnFiltro();
    load();
  </script>
</body>
</html>
